<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordStock</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WordStock">
    <style>
        :root { --primary: #007bff; --success: #28a745; --bg: #f0f2f5; --text: #333; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); line-height: 1.5; }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h1 { font-size: 1.2rem; text-align: center; color: #555; margin-bottom: 20px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; position: relative; }
        .btn-sync { background: #6f42c1; color: white; margin-bottom: 15px; box-shadow: 0 4px 0 #5634a1; }
        .btn-sync:active { transform: translateY(2px); box-shadow: none; }
        .btn-backup { background: #6c757d; color: white; margin-bottom: 15px; box-shadow: 0 4px 0 #5a6268; }
        .btn-backup:active { transform: translateY(2px); box-shadow: none; }
        .btn-main { background: var(--primary); color: white; }
        
        #quiz-area { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; color: white; z-index: 1000; padding: 25px; box-sizing: border-box; overflow-y: auto; }
        #progress-bar-container { width: 100%; height: 6px; background: #333; position: fixed; top: 0; left: 0; z-index: 1001; }
        #progress-bar { width: 0%; height: 100%; background: var(--success); transition: 0.3s; }
        
        .quiz-card { text-align: center; margin-top: 30px; }
        .q-word { font-size: 2.8rem; font-weight: bold; margin: 10px 0; color: #fff; cursor: pointer; }
        .answer-box { display: none; background: #2d2d2d; padding: 20px; border-radius: 12px; text-align: left; border-left: 5px solid var(--primary); margin-bottom: 20px; }
        .highlight { color: #ffd700; font-weight: bold; }
        
        .choice-group { display: grid !important; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; display: none; }
        .btn-sub-label { display: block; font-size: 0.65rem; font-weight: normal; opacity: 0.8; margin-top: 4px; }
        
        .progress-indicator { background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 15px; color: #aaa; display: inline-block; }
        .add-card { background: #ffffff; border-radius: 15px; overflow: hidden; margin-bottom: 20px; border: 1px solid #e0e4e8; }
        .add-header { background: #f8f9fa; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; color: #555; }
        .add-body { padding: 20px; display: none; border-top: 1px solid #eee; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; color: #888; margin-bottom: 5px; margin-left: 5px; }
        input[type="text"], input[type="password"], textarea, select { width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 10px; background: #fcfcfc; font-size: 16px; transition: 0.3s; box-sizing: border-box; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; max-width: 450px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .btn-delete { background: #dc3545; color: white; border: none; border-radius: 10px; padding: 0 15px; cursor: pointer; font-size: 1.2rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“š WordStock <small style="font-size:0.6rem; color:#999;">by yaneuraenglish</small></h1>

    <div id="teacher-msg-card" class="card" style="font-size: 0.85rem; background: #fff3cd; border: none; padding: 10px 15px; border-radius: 10px;">
        <strong>é–‹ç™ºè€…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong><br>
        <span id="teacher-message">ã€Œå–ã‚Šè¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã§æœ€æ–°ã®å˜èªã‚’åŒæœŸã—ã¦ãã ã•ã„ã€‚</span>
    </div>

    <div class="card" style="text-align:center;">
        <div style="margin-bottom: 15px; text-align: left;">
            <label style="font-size: 0.8rem; color: #888; font-weight: bold;">ã‚³ãƒ¼ã‚¹ãƒ»é›£æ˜“åº¦ã‚’é¸æŠï¼š</label>
            <div style="display: flex; gap: 8px; margin-top: 5px;">
                <select id="level-filter" onchange="updateDisplay()">
                    <option value="ALL">ã™ã¹ã¦ã®å˜èª</option>
                </select>
                <button class="btn-delete" onclick="deleteSelectedCategory()">ğŸ—‘ï¸</button>
            </div>
        </div>
        <h2 id="review-count">ä»Šæ—¥ã®å¾©ç¿’: 0 èª</h2>
        <button class="btn btn-main" onclick="startReview()">å¾©ç¿’é–‹å§‹</button>
    </div>

    <button class="btn btn-sync" onclick="openSyncModal()">ğŸ”„ æœ€æ–°ã®å˜èªã‚’å–ã‚Šè¾¼ã‚€</button>

    <div class="card" style="padding: 15px;">
        <label style="font-size: 0.85rem; font-weight: bold; color: #555;">ğŸ”Š èª­ã¿ä¸Šã’è¨­å®š</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
            <div class="input-group" style="margin-bottom: 0;">
                <label>å£°ãƒ»åœ°åŸŸ (US/UKç­‰)</label>
                <select id="voice-select" style="font-size: 0.75rem;" onchange="saveVoiceSettings()"></select>
            </div>
            <div class="input-group" style="margin-bottom: 0;">
                <label>é€Ÿåº¦: <span id="rate-val">0.9</span></label>
                <input type="range" id="voice-rate" min="0.5" max="1.5" step="0.1" value="0.9" oninput="document.getElementById('rate-val').innerText=this.value; saveVoiceSettings();">
            </div>
        </div>
    </div>

    <div class="add-card">
        <div class="add-header" onclick="toggleAddForm()">
            <span>è‡ªåˆ†ã§å˜èªã‚’è¿½åŠ ï¼ˆè‡ªç¿’ç”¨ï¼‰</span>
            <span id="add-icon">ï¼‹</span>
        </div>
        <div id="add-body" class="add-body">
            <div class="input-group"><label>è‹±å˜èª</label><input type="text" id="word" placeholder="apple"></div>
            <div class="input-group"><label>æ„å‘³</label><input type="text" id="meaning" placeholder="ã‚Šã‚“ã”"></div>
            <div style="display: flex; gap: 10px;">
                <div class="input-group" style="flex: 1;"><label>å“è©</label><input type="text" id="type" placeholder="åè©"></div>
                <div class="input-group" style="flex: 1;"><label>ç™ºéŸ³</label><input type="text" id="pronunciation" placeholder="Ã¦pl"></div>
            </div>
            <div class="input-group"><label>ä¾‹æ–‡</label><textarea id="sentence" rows="2" placeholder="I like apples."></textarea></div>
            <div class="input-group"><label>ãƒ¡ãƒ¢ãƒ»è§£èª¬</label><textarea id="advice" rows="2" placeholder="èªæºãªã©"></textarea></div>
            <button class="btn" style="background: var(--success); color: white;" onclick="saveWord()">ã‚¹ãƒãƒ›ã«ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>

    <div style="display: flex; gap: 10px;">
        <button class="btn btn-backup" onclick="exportData()" style="flex:1; font-size: 0.8rem;">ğŸ“¥ ä¿å­˜</button>
        <button class="btn btn-backup" onclick="document.getElementById('importFile').click()" style="flex:1; font-size: 0.8rem;">ğŸ“¤ å¾©å…ƒ</button>
    </div>
    <input type="file" id="importFile" accept=".json" onchange="importData(event)">
</div>

<div id="sync-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">ğŸ“¥ å˜èªã®å–ã‚Šè¾¼ã¿è¨­å®š</div>
        <input type="password" id="secret-key-input" placeholder="åˆè¨€è‘‰">
        <div id="category-checkboxes" class="checkbox-group" style="margin-top:15px;"></div>
        <div class="btn-group" style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn" style="background:#6c757d; color:white; flex:1;" onclick="closeSyncModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn" style="background:var(--success); color:white; flex:1;" onclick="syncFromSheet()">å–ã‚Šè¾¼ã‚€</button>
        </div>
    </div>
</div>

<div id="quiz-area">
    <div id="progress-bar-container"><div id="progress-bar"></div></div>
    <div class="quiz-card">
        <div class="progress-indicator" id="progress-indicator">å•é¡Œ 1/10</div>
        <div id="q-type-label" style="font-size:0.9rem; color:var(--primary)"></div>
        <div id="q-word" class="q-word" onclick="speak(this.innerText)"></div>
        <div style="color: #aaa; font-size: 0.8rem; margin-top: -10px; margin-bottom: 10px;">(ã‚¿ãƒƒãƒ—ã§å†ç”Ÿ ğŸ”Š)</div>
        <div id="q-pron" style="color:#aaa; margin-bottom:20px;"></div>
        
        <button id="show-ans-btn" class="btn btn-main" onclick="showAnswer()">ç­”ãˆã‚’è¦‹ã‚‹</button>
        
        <div id="answer-box" class="answer-box">
            <p><strong>æ„å‘³:</strong> <span id="q-meaning" style="font-size:1.2rem;"></span></p>
            <p><strong>ä¾‹æ–‡:</strong> <br><span id="q-sentence" style="font-style:italic; color:#ddd;"></span></p>
            <p><strong>è§£èª¬:</strong> <br><span id="q-advice" class="highlight"></span></p>
        </div>

        <div id="choice-group" class="choice-group">
            <button class="btn" style="background:#dc3545; color:white;" onclick="submitResult(1)">å¿˜ã‚ŒãŸ</button>
            <button class="btn" style="background:#ffc107; color:#333;" onclick="submitResult(2)">ä¸å®‰</button>
            <button class="btn" style="background:#28a745; color:white;" onclick="submitResult(3)">ã‚ã‹ã£ãŸ</button>
            <button class="btn" style="background:#007bff; color:white;" onclick="submitResult(4)">å®Œç’§ï¼</button>
        </div>
        <button class="btn" style="background:transparent; color:#666; margin-top:20px;" onclick="closeQuiz()">ä¸­æ–­</button>
    </div>
</div>

<script>
    const _p1 = "18XxJwzl4sF3_";
    const _p2 = "kHJp8qk-QUUfvsqMM3AyJNKdWmyUFUE";
    const SECRET_KEY = "19951228";
    let myVocab = JSON.parse(localStorage.getItem('my_vocab_data')) || [];
    let voices = [];

    // ğŸ”Š å…¨åœ°åŸŸã®è‹±èªï¼ˆen-XXï¼‰ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
    function initVoices() {
        // ã™ã¹ã¦ã®éŸ³å£°ã‚’ä¸€åº¦å–å¾—
        const allVoices = speechSynthesis.getVoices();
        if (allVoices.length === 0) return; // ã¾ã ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

        // ã€Œenã€ãŒå«ã¾ã‚Œã‚‹ã™ã¹ã¦ã®è‹±èªãƒœã‚¤ã‚¹ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        voices = allVoices.filter(v => v.lang.toLowerCase().includes('en'));
        
        const select = document.getElementById('voice-select');
        const savedVoiceName = localStorage.getItem('voice_name');
        
        // ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ (US, GB, AUãªã©ãŒå…¥ã‚‹)
        select.innerHTML = voices.map(v => 
            `<option value="${v.name}" ${v.name === savedVoiceName ? 'selected' : ''}>${v.name} (${v.lang})</option>`
        ).join('');
    }

    // ç«¯æœ«ã«ã‚ˆã£ã¦ãƒªã‚¹ãƒˆå–å¾—ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒç•°ãªã‚‹ãŸã‚äºŒé‡ã§ç›£è¦–
    window.speechSynthesis.onvoiceschanged = initVoices;
    setTimeout(initVoices, 500); // äºˆå‚™

    function saveVoiceSettings() {
        localStorage.setItem('voice_name', document.getElementById('voice-select').value);
        localStorage.setItem('voice_rate', document.getElementById('voice-rate').value);
    }

    function speak(text) {
        if (!text) return;
        speechSynthesis.cancel();
        const wordOnly = text.split('\n')[0].replace(/[\[\/].*?[\]\/]/g, '').trim();
        const uttr = new SpeechSynthesisUtterance(wordOnly);
        
        const selectedVoiceName = document.getElementById('voice-select').value;
        const selectedVoice = voices.find(v => v.name === selectedVoiceName);
        if (selectedVoice) {
            uttr.voice = selectedVoice;
            uttr.lang = selectedVoice.lang; // æ˜ç¤ºçš„ã«è¨€èªã‚’è¨­å®š
        }
        
        uttr.rate = parseFloat(document.getElementById('voice-rate').value) || 0.9;
        speechSynthesis.speak(uttr);
    }

    // --- ä»¥ä¸‹ã€æ—¢å­˜ã®å…¨æ©Ÿèƒ½ã‚’ç¶­æŒ ---

    function updateDisplay() {
        const today = new Date().toISOString().split('T')[0];
        const select = document.getElementById('level-filter');
        const currentSelection = select.value;
        const levels = [...new Set(myVocab.map(v => v.level))].filter(Boolean);
        select.innerHTML = '<option value="ALL">ã™ã¹ã¦ã®å˜èª</option>' + levels.map(l => `<option value="${l}" ${l===currentSelection?'selected':''}>${l}</option>`).join('');
        const activeFilter = select.value;
        const dueCount = myVocab.filter(v => (!v.nextReview || v.nextReview <= today) && (activeFilter === "ALL" || v.level === activeFilter)).length;
        document.getElementById('review-count').innerText = `ä»Šæ—¥ã®å¾©ç¿’: ${dueCount} èª`;
    }

    function startReview() {
        const today = new Date().toISOString().split('T')[0];
        const filter = document.getElementById('level-filter').value;
        quizList = myVocab.filter(v => (!v.nextReview || v.nextReview <= today) && (filter === "ALL" || v.level === filter));
        if (quizList.length === 0) return alert("å¾©ç¿’ã™ã¹ãå˜èªã¯ã‚ã‚Šã¾ã›ã‚“ï¼");
        quizList.sort(() => Math.random() - 0.5);
        currentIdx = 0;
        document.getElementById('quiz-area').style.display = "block";
        showQuestion();
    }

    function showQuestion() {
        const q = quizList[currentIdx];
        document.getElementById('progress-bar').style.width = ((currentIdx + 1) / quizList.length * 100) + "%";
        document.getElementById('progress-indicator').innerText = `å•é¡Œ ${currentIdx + 1}/${quizList.length}`;
        document.getElementById('q-word').innerText = q.word;
        document.getElementById('q-type-label').innerText = `[${q.level || ''}] ${q.type || ''}`;
        document.getElementById('q-pron').innerText = q.pronunciation ? `[ ${q.pronunciation} ]` : "";
        document.getElementById('q-meaning').innerText = q.meaning;
        document.getElementById('q-sentence').innerText = q.sentence || "";
        document.getElementById('q-advice').innerText = q.advice || "";
        document.getElementById('answer-box').style.display = "none";
        document.getElementById('choice-group').style.display = "none";
        document.getElementById('show-ans-btn').style.display = "block";
        speak(q.word);
    }

    function showAnswer() {
        document.getElementById('answer-box').style.display = "block";
        document.getElementById('choice-group').style.display = "grid";
        document.getElementById('show-ans-btn').style.display = "none";
    }

    function submitResult(score) {
        const target = myVocab.find(v => v.word === quizList[currentIdx].word);
        let interval = target.interval || 0;
        if (score === 1) interval = 0;
        else if (score === 2) interval = (interval === 0) ? 1 : Math.max(1, Math.floor(interval * 1.2));
        else if (score === 3) interval = (interval === 0) ? 4 : Math.floor(interval * 2.0);
        else if (score === 4) interval = (interval === 0) ? 7 : Math.floor(interval * 3.5);
        target.interval = interval;
        let next = new Date();
        next.setDate(next.getDate() + interval);
        target.nextReview = next.toISOString().split('T')[0];
        localStorage.setItem('my_vocab_data', JSON.stringify(myVocab));
        currentIdx++;
        if (currentIdx < quizList.length) showQuestion(); else { alert("å…¨å•é¡Œã‚’å®Œäº†ã—ã¾ã—ãŸï¼"); closeQuiz(); }
    }

    function deleteSelectedCategory() {
        const filter = document.getElementById('level-filter').value;
        if (!confirm(filter === "ALL" ? "å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ" : `ã‚«ãƒ†ã‚´ãƒªã€Œ${filter}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        myVocab = filter === "ALL" ? [] : myVocab.filter(v => v.level !== filter);
        localStorage.setItem('my_vocab_data', JSON.stringify(myVocab));
        updateDisplay();
    }

    function saveWord() {
        const w = document.getElementById('word').value;
        const m = document.getElementById('meaning').value;
        if(!w || !m) return alert("å¿…é ˆå…¥åŠ›ã§ã™");
        myVocab.push({
            level: "è‡ªç¿’", type: document.getElementById('type').value, word: w,
            pronunciation: document.getElementById('pronunciation').value, meaning: m,
            sentence: document.getElementById('sentence').value, advice: document.getElementById('advice').value,
            nextReview: new Date().toISOString().split('T')[0], interval: 0
        });
        localStorage.setItem('my_vocab_data', JSON.stringify(myVocab));
        updateDisplay(); alert("ä¿å­˜ã—ã¾ã—ãŸ");
    }

    function openSyncModal() { document.getElementById('sync-modal').style.display = 'flex'; fetchAvailableCategories(); }
    function closeSyncModal() { document.getElementById('sync-modal').style.display = 'none'; }
    
    async function fetchAvailableCategories() {
        const url = `https://docs.google.com/spreadsheets/d/${_p1+_p2}/gviz/tq?tqx=out:csv`;
        try {
            const res = await fetch(url); const csv = await res.text();
            const rows = csv.split(/\r?\n(?=(?:(?:[^"]*"){2})*[^"]*$)/).slice(1);
            const cats = [...new Set(rows.map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)[0].replace(/"/g,'').trim()))].filter(c => c && !c.includes("MESSAGE"));
            document.getElementById('category-checkboxes').innerHTML = cats.map(c => `<div class="checkbox-item"><input type="checkbox" value="${c}" checked> ${c}</div>`).join('');
        } catch(e) { alert("ã‚«ãƒ†ã‚´ãƒªå–å¾—å¤±æ•—"); }
    }

    async function syncFromSheet() {
        if (document.getElementById('secret-key-input').value !== SECRET_KEY) return alert("åˆè¨€è‘‰ãŒé•ã„ã¾ã™");
        const url = `https://docs.google.com/spreadsheets/d/${_p1+_p2}/gviz/tq?tqx=out:csv`;
        try {
            const res = await fetch(url); const csv = await res.text();
            const rows = csv.split(/\r?\n(?=(?:(?:[^"]*"){2})*[^"]*$)/).slice(1);
            const selectedCats = Array.from(document.querySelectorAll('#category-checkboxes input:checked')).map(cb => cb.value);
            rows.forEach(r => {
                const cols = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g,'').trim());
                if(r.includes("MESSAGE:")) document.getElementById('teacher-message').innerText = r.match(/MESSAGE:([^,"]+)/)[1];
                if (selectedCats.includes(cols[0]) && !myVocab.some(v => v.word === cols[2])) {
                    myVocab.push({ level: cols[0], type: cols[1], word: cols[2], pronunciation: cols[2].split('\n')[1]||"", meaning: cols[3], sentence: cols[4]||"", advice: cols[5]||"", nextReview: new Date().toISOString().split('T')[0], interval: 0 });
                }
            });
            localStorage.setItem('my_vocab_data', JSON.stringify(myVocab));
            updateDisplay(); closeSyncModal(); alert("åŒæœŸå®Œäº†");
        } catch(e) { alert("åŒæœŸå¤±æ•—"); }
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(myVocab, null, 2)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'wordstock_backup.json'; a.click();
    }
    function importData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => { myVocab = JSON.parse(ev.target.result); localStorage.setItem('my_vocab_data', JSON.stringify(myVocab)); updateDisplay(); alert("å¾©å…ƒå®Œäº†"); };
        reader.readAsText(e.target.files[0]);
    }
    function closeQuiz() { document.getElementById('quiz-area').style.display = "none"; updateDisplay(); }
    function toggleAddForm() {
        const b = document.getElementById('add-body');
        b.style.display = b.style.display === "block" ? "none" : "block";
        document.getElementById('add-icon').innerText = b.style.display === "block" ? "ãƒ¼" : "ï¼‹";
    }

    window.onload = () => {
        const savedRate = localStorage.getItem('voice_rate');
        if(savedRate) { document.getElementById('voice-rate').value = savedRate; document.getElementById('rate-val').innerText = savedRate; }
        updateDisplay(); initVoices();
    };
</script>
</body>
</html>
