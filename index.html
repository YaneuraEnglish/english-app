<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Vocab Sync - Teacher's Special</title>
    <style>
        :root { --primary: #007bff; --success: #28a745; --bg: #f0f2f5; --text: #333; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); line-height: 1.5; }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 20px; }
        
        h1 { font-size: 1.2rem; text-align: center; color: #555; margin-bottom: 20px; }
        h2 { font-size: 1rem; margin-top: 0; color: #777; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        
        input, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        .level-group { display: flex; gap: 8px; margin-bottom: 15px; }
        .level-btn { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 0.8rem; cursor: pointer; background: white; font-weight: bold; }
        .level-btn.active { border-color: var(--primary); background: var(--primary); color: white; }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-sync { background: #6f42c1; color: white; margin-bottom: 15px; box-shadow: 0 4px 0 #5634a1; }
        .btn-sync:active { transform: translateY(2px); box-shadow: none; }
        .btn-main { background: var(--primary); color: white; }
        .btn-save { background: var(--success); color: white; }

        /* ã‚¯ã‚¤ã‚ºç”»é¢ */
        #quiz-area { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; color: white; z-index: 1000; padding: 25px; box-sizing: border-box; overflow-y: auto; }
        .quiz-card { text-align: center; margin-top: 20px; }
        .q-word { font-size: 2.8rem; font-weight: bold; margin: 10px 0; color: #fff; }
        .q-sub { color: #aaa; font-size: 1.1rem; margin-bottom: 30px; }
        
        .answer-box { display: none; background: #2d2d2d; padding: 20px; border-radius: 12px; text-align: left; border-left: 5px solid var(--primary); }
        .highlight { color: #ffd700; font-weight: bold; }
        
        .choice-group { display: flex; gap: 15px; margin-top: 30px; display: none; }
        .btn-forget { background: #dc3545; color: white; flex: 1; }
        .btn-know { background: var(--success); color: white; flex: 1; }
    </style>
</head>
<body>

<div class="container" id="main-view">
    <h1>ğŸ“š English Vocab Sync</h1>

    <button class="btn btn-sync" onclick="syncFromSheet()">ğŸ”„ å…ˆç”Ÿã®æœ€æ–°å˜èªã‚’å–ã‚Šè¾¼ã‚€</button>

    <div class="card" style="text-align:center;">
        <h2 id="review-count">ä»Šæ—¥ã®å¾©ç¿’: 0 èª</h2>
        <button class="btn btn-main" onclick="startReview()">å¾©ç¿’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹</button>
    </div>

    <div class="card">
        <h2>ğŸ†• è‡ªåˆ†ã§å˜èªã‚’è¿½åŠ </h2>
        <input type="text" id="word" placeholder="è‹±å˜èª">
        <input type="text" id="meaning" placeholder="æ„å‘³">
        <input type="text" id="type" placeholder="å“è©/å±æ€§ (ä¾‹: å‹•è©, æ¥é ­è¾)">
        <input type="text" id="pronunciation" placeholder="ç™ºéŸ³è¨˜å·/ã‚«ã‚¿ã‚«ãƒŠ">
        
        <div class="level-group">
            <div class="level-btn" onclick="selectLevel(this)">å…±é€šãƒ†ã‚¹ãƒˆ</div>
            <div class="level-btn" onclick="selectLevel(this)">äºŒæ¬¡è©¦é¨“</div>
            <div class="level-btn" onclick="selectLevel(this)">é›£é–¢ç§å¤§</div>
        </div>

        <textarea id="sentence" rows="2" placeholder="çŸ­ã„è‹±æ–‡ã¨å’Œè¨³"></textarea>
        <textarea id="advice" rows="2" placeholder="æ ¸å¿ƒè§£èª¬ï¼ˆå…ˆç”Ÿã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼‰"></textarea>
        
        <button class="btn btn-save" onclick="saveWord()">ã‚¹ãƒãƒ›ã«ä¿å­˜</button>
    </div>
</div>

<div id="quiz-area">
    <div class="quiz-card">
        <div id="q-type-label" style="font-size:0.9rem; color:var(--primary)"></div>
        <div id="q-word" class="q-word"></div>
        <div id="q-pron" class="q-sub"></div>
        
        <button id="show-ans-btn" class="btn btn-main" onclick="showAnswer()">ç­”ãˆã‚’è¦‹ã‚‹</button>
        
        <div id="answer-box" class="answer-box">
            <p><strong>æ„å‘³:</strong> <span id="q-meaning" style="font-size:1.2rem; color:white;"></span></p>
            <p><strong>è‹±æ–‡:</strong> <br><span id="q-sentence" style="font-style:italic; color:#ddd;"></span></p>
            <p><strong>æ ¸å¿ƒè§£èª¬:</strong> <br><span id="q-advice" class="highlight"></span></p>
        </div>

        <div id="choice-group" class="choice-group">
            <button class="btn btn-forget" onclick="submitResult(false)">å¿˜ã‚ŒãŸ...</button>
            <button class="btn btn-know" onclick="submitResult(true)">è¦šãˆãŸï¼</button>
        </div>
        
        <button class="btn" style="background:transparent; color:#666; margin-top:20px;" onclick="closeQuiz()">ä¸­æ–­ã™ã‚‹</button>
    </div>
</div>

<script>
    let myVocab = JSON.parse(localStorage.getItem('my_vocab_data')) || [];
    let selectedLevel = "";
    let quizList = [];
    let currentIdx = 0;

    function updateDisplay() {
        const today = new Date().toISOString().split('T')[0];
        const due = myVocab.filter(v => !v.nextReview || v.nextReview <= today);
        document.getElementById('review-count').innerText = `ä»Šæ—¥ã®å¾©ç¿’: ${due.length} èª`;
    }
    updateDisplay();

    function selectLevel(btn) {
        document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedLevel = btn.innerText;
    }

    function saveWord() {
        const word = document.getElementById('word').value;
        if (!word || !selectedLevel) return alert("å˜èªã¨é›£æ˜“åº¦ã¯å¿…é ˆã§ã™");
        myVocab.push({
            level: selectedLevel, type: document.getElementById('type').value, word: word.trim(),
            pronunciation: document.getElementById('pronunciation').value, meaning: document.getElementById('meaning').value,
            sentence: document.getElementById('sentence').value, advice: document.getElementById('advice').value,
            nextReview: new Date().toISOString().split('T')[0], interval: 0
        });
        localStorage.setItem('my_vocab_data', JSON.stringify(myVocab));
        alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
        location.reload();
    }

    // â˜… åŒæœŸæ©Ÿèƒ½ï¼šCORSå›é¿ç”¨ã®URLæ§‹ç¯‰
    async function syncFromSheet() {
        // æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
        const sheetId = "1IrX_Uwr9hx2LLL-Irt-KQRR_FFk_LQpT8EF0WytWTAokoOd0dPBF4e4PiW3KjPz3kZEHWbHIqTWTJ";
        const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;
        
        try {
            const res = await fetch(sheetUrl);
            if (!res.ok) throw new Error('Network error');
            const csv = await res.text();
            
            // CSVã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆç°¡æ˜“ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
            const lines = csv.split(/\r?\n/).slice(1);
            let count = 0;
            lines.forEach(line => {
                const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const clean = (str) => str ? str.replace(/^"|"$/g, '').trim() : "";

                if (cols.length >= 3 && clean(cols[2])) {
                    const w = clean(cols[2]);
                    if (!myVocab.some(v => v.word === w)) {
                        myVocab.push({
                            level: clean(cols[0]), type: clean(cols[1]), word: w,
                            pronunciation: clean(cols[3]), meaning: clean(cols[4]),
                            sentence: clean(cols[5]), advice: clean(cols[6]),
                            nextReview: new Date().toISOString().split('T')[0], interval: 0
                        });
                        count++;
                    }
                }
            });
            localStorage.setItem('my_vocab_data', JSON.stringify(myVocab));
            alert(count + "ä»¶ã®æ–°ç€å˜èªã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼");
            updateDisplay();
        } catch (e) {
            console.error(e);
            alert("åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒ»ã‚¦ã‚§ãƒ–ã«å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ\nãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«ç¹‹ãŒã£ã¦ã„ã¾ã™ã‹ï¼Ÿ");
        }
    }

    function startReview() {
        const today = new Date().toISOString().split('T')[0];
        quizList = myVocab.filter(v => !v.nextReview || v.nextReview <= today);
        if (quizList.length === 0) return alert("å¾©ç¿’ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
        currentIdx = 0;
        document.getElementById('quiz-area').style.display = "block";
        showQuestion();
    }

    function showQuestion() {
        const q = quizList[currentIdx];
        document.getElementById('q-word').innerText = q.word;
        document.getElementById('q-type-label').innerText = `[${q.level}] ${q.type}`;
        document.getElementById('q-pron').innerText = q.pronunciation ? `[ ${q.pronunciation} ]` : "";
        document.getElementById('q-meaning').innerText = q.meaning;
        document.getElementById('q-sentence').innerText = q.sentence;
        document.getElementById('q-advice').innerText = q.advice;
        document.getElementById('answer-box').style.display = "none";
        document.getElementById('choice-group').style.display = "none";
        document.getElementById('show-ans-btn').style.display = "block";
    }

    function showAnswer() {
        document.getElementById('answer-box').style.display = "block";
        document.getElementById('choice-group').style.display = "flex";
        document.getElementById('show-ans-btn').style.display = "none";
    }

    function submitResult(isCorrect) {
        const target = myVocab.find(v => v.word === quizList[currentIdx].word);
        if(isCorrect) {
            target.interval = (target.interval === 0) ? 1 : target.interval * 2;
        } else {
            target.interval = 0;
        }
        let next = new Date();
        next.setDate(next.getDate() + (isCorrect ? target.interval : 0));
        target.nextReview = next.toISOString().split('T')[0];
        localStorage.setItem('my_vocab_data', JSON.stringify(myVocab));
        currentIdx++;
        if(currentIdx < quizList.length) showQuestion();
        else { alert("æœ¬æ—¥ã®å¾©ç¿’å®Œäº†ï¼"); closeQuiz(); }
    }

    function closeQuiz() {
        document.getElementById('quiz-area').style.display = "none";
        updateDisplay();
    }
</script>
</body>
</html>